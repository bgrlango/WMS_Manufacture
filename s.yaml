edition: 3.0.0
name: wms-fastapi-query-service
access: default

resources:
  fastApiQueryService:
    component: fc3
    props:
      region: ap-southeast-5
      
      # Function metadata
      functionName: Fastapi-queryservice
      description: "WMS Manufacturing - FastAPI Query Service (CQRS Read Operations)"
      
      # Runtime configuration
      runtime: custom.debian10
      handler: bootstrap.http_handler
      
      # Resource allocation
      cpu: 0.35
      memorySize: 512
      diskSize: 512
      timeout: 300
      instanceConcurrency: 5
      
      # Custom runtime configuration
      customRuntimeConfig:
        port: 9000
        command:
          - python3
          - bootstrap.py
      
      # Code location - CRITICAL: Must match deployment directory
      code: ./Fastapi-queryservice
      
      # Environment variables - Alibaba FC paths
      environmentVariables:
        # Python paths
        PYTHONPATH: /code:/code/app:/opt/python3.9
        LD_LIBRARY_PATH: /code:/code/lib:/usr/lib:/opt/lib:/usr/local/lib
        PATH: /opt/python3.9/bin:/usr/local/bin/apache-maven/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/ruby/bin:/opt/bin:/code:/code/bin
        
        # Application
        CODE_DIR: /code
        FC_PORT: "9000"
        FC_HOST: "0.0.0.0"
        FC_FUNCTION_NAME: Fastapi-queryservice
        
        # Python runtime
        PYTHONUNBUFFERED: "1"
        PYTHONDONTWRITEBYTECODE: "1"
        PYTHONIOENCODING: utf-8
        
        # Database (configure these in Alibaba console or .env)
        # DB_HOST: "your-rds-host.ap-southeast-5.rds.aliyuncs.com"
        # DB_PORT: "3306"
        # DB_USER: "root"
        # DB_NAME: "wms_manufacture"
      
      # Layers - Python and Flask packages from Alibaba
      layers:
        - acs:fc:ap-southeast-5:official:layers/Python39/versions/2
        - acs:fc:ap-southeast-5:official:layers/Python39-Package-Collection/versions/2
        - acs:fc:ap-southeast-5:official:layers/Python3-Flask2x/versions/2
      
      # Logging configuration
      logConfig:
        enableRequestMetrics: true
        enableInstanceMetrics: true
        logBeginRule: DefaultRegex
        enableCustomExtraLog: true
      
      # Network
      internetAccess: true
      instanceIsolationMode: SHARE
      sessionAffinity: NONE
      
      # Performance
      disableOndemand: false
      alwaysAllocateCPU: false
      
      # Auto-scaling
      provisionConfig:
        defaultTarget: 1
        alwaysAllocateCPU: false
        alwaysAllocateGPU: false
      
      # HTTP Trigger
      triggers:
        - triggerName: defaultTrigger
          description: "HTTP trigger for all methods"
          triggerType: http
          qualifier: LATEST
          triggerConfig:
            methods:
              - GET
              - POST
              - PUT
              - DELETE
              - HEAD
              - OPTIONS
              - PATCH
            authType: anonymous
            disableURLInternet: false
